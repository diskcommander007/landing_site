<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Stream Player with Vertical Info & Smooth Gradient</title>
  <!-- Load FontAwesome from CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
  <style>
    /* The body serves as our gradient container with a 30s transition */
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      background: linear-gradient(45deg, rgb(255,113,71), rgb(224,65,127));
      transition: background 30s ease;
      font-family: Arial, sans-serif;
    }
    /* Center the player container */
    #playerContainer {
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 10px;
      width: 320px;
      margin: auto;
      text-align: center;
      position: relative;
      top: 50%;
      transform: translateY(-50%);
    }
    /* Wrapper for album art */
    #artWrapper {
      width: 300px;
      margin: 0 auto;
      margin-top: 10px;
    }
    /* Album art styling: 300px square */
    #albumArt {
      width: 300px;
      height: 300px;
      object-fit: cover;
      border-radius: 10px;
      display: block;
    }
    /* Info container for text and controls */
    #infoContainer {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 300px;
    }
    /* Text block with vertical stack of title and artist */
    #textInfo {
      text-align: left;
      color: #fff;
      margin-top: 10px;
      margin-bottom: 10px;
      flex: 1;
    }
    #songTitle {
      font-size: 20px;
      margin: 0;
      padding: 0;
      font-weight: bold;
      line-height: 1.2;
    }
    #songArtist {
      font-size: 16px;
      margin: 4px 0 0;
      color: #fff;
    }
    /* Custom play/pause button using FontAwesome icons */
    #playPauseButton {
      background: none;
      border: none;
      color: #fff;
      font-size: 38px; 
      cursor: pointer;
      margin-left: 10px;
      flex-shrink: 0;
    }
    /* Hide native audio controls */
    audio {
      display: none;
    }
  </style>
</head>
<!-- Give the body an id for gradient transitions -->
<body id="gradient-button-transition">
  <div id="playerContainer">
    <div id="artWrapper">
      <!-- Album art (placeholder if none available) -->
      <img id="albumArt" src="https://dummyimage.com/300x300/444/fff&text=No+Art" alt="Album Art">
      <!-- Info container: vertical text info and play/pause button -->
      <div id="infoContainer">
        <div id="textInfo">
          <div id="songTitle">Loading...</div>
          <div id="songArtist">Loading...</div>
        </div>
        <button id="playPauseButton">
          <i id="icon" class="fas fa-play"></i>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Hidden audio element for the live stream -->
  <audio id="audio" crossorigin="anonymous" src="https://stream.derfi.online:8000/main.mp3?_ic2=1739569227911" loop></audio>
  
  <script>
    /* -------------------------------------------------
       Metadata Fetching from AzuraCast Now Playing Endpoint
    ------------------------------------------------- */
    async function fetchMetadata() {
      try {
        const response = await fetch("https://stream.derfi.online/api/station/1/nowplaying");
        const data = await response.json();
        // Expected JSON structure: data.now_playing.song.title, .artist, .art
        const song = data.now_playing.song || {};
        const title = song.title || "Title";
        const artist = song.artist || "Artist";
        const art = song.art || "https://via.placeholder.com/300?text=No+Art";
        
        document.getElementById("songTitle").innerText = title;
        document.getElementById("songArtist").innerText = artist;
        document.getElementById("albumArt").src = art;
      } catch (error) {
        console.error("Error fetching metadata:", error);
      }
    }
    // Initial fetch and then every 30 seconds.
    fetchMetadata();
    setInterval(fetchMetadata, 30000);
    
    /* -------------------------------------------------
       Custom Play/Pause Controls using FontAwesome
    ------------------------------------------------- */
    const audio = document.getElementById("audio");
    const playPauseButton = document.getElementById("playPauseButton");
    const iconElement = document.getElementById("icon");
    
    playPauseButton.addEventListener("click", () => {
      if (audio.paused) {
        audio.play();
        iconElement.classList.remove("fa-play");
        iconElement.classList.add("fa-pause");
      } else {
        audio.pause();
        iconElement.classList.remove("fa-pause");
        iconElement.classList.add("fa-play");
      }
    });
    
    /* -------------------------------------------------
       Frequency-Based Smooth Gradient Transition
       Using Provided Gradient Code
    ------------------------------------------------- */
    // Set the angle for our gradient.
    const angle = 45;
    // Define your gradient stops.
    const gradientStopOne = [
      { pct: 0,  color: { r: 255, g: 113, b: 71 } },
      { pct: 100, color: { r: 0, g: 55, b: 255 } }
    ];
    const gradientStopTwo = [
      { pct: 0,  color: { r: 224, g: 65, b: 127 } },
      { pct: 100, color: { r: 0, g: 173, b: 255 } }
    ];
    
    // Set initial background using the first stops.
    let c1 = gradientStopOne[0].color;
    let c2 = gradientStopTwo[0].color;
    document.getElementById('gradient-button-transition').style.background = 
      `linear-gradient(${angle}deg, rgb(${c1.r}, ${c1.g}, ${c1.b}), rgb(${c2.r}, ${c2.g}, ${c2.b}))`;
    
    // Function to interpolate between two colors given a percentage.
    const getColor = function(pct, colorSet) {
      let i;
      for (i = 1; i < colorSet.length - 1; i++) {
        if (pct < colorSet[i].pct) {
          break;
        }
      }
      const lower = colorSet[i - 1];
      const upper = colorSet[i];
      const range = upper.pct - lower.pct;
      const rangePct = (pct - lower.pct) / range;
      const pctLower = 1 - rangePct;
      const pctUpper = rangePct;
      const color = {
        r: Math.floor(lower.color.r * pctLower + upper.color.r * pctUpper),
        g: Math.floor(lower.color.g * pctLower + upper.color.g * pctUpper),
        b: Math.floor(lower.color.b * pctLower + upper.color.b * pctUpper)
      };
      return `rgb(${color.r}, ${color.g}, ${color.b})`;
    };
    
    // Setup the Web Audio API for frequency analysis.
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    const source = audioCtx.createMediaElementSource(audio);
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    source.connect(analyser);
    analyser.connect(audioCtx.destination);
    
    const frequencyData = new Uint8Array(analyser.frequencyBinCount);
    let smoothedValue = 0;
    // Very low smoothing factor for extremely slow transitions.
    const smoothingFactor = 0.005;
    
    // Update the gradient once per second.
    function updateGradient() {
      analyser.getByteFrequencyData(frequencyData);
      const maxFreq = Math.max(...frequencyData);
      smoothedValue = smoothedValue * (1 - smoothingFactor) + maxFreq * smoothingFactor;
      // Normalize smoothed value (0-255) to percentage (0-100)
      const pct = (smoothedValue / 255) * 100;
      const newC1 = getColor(pct, gradientStopOne);
      const newC2 = getColor(pct, gradientStopTwo);
      document.getElementById('gradient-button-transition').style.background =
        `linear-gradient(${angle}deg, ${newC1}, ${newC2})`;
    }
    
    setInterval(updateGradient, 1000);
    
    // Ensure the audio context resumes on playback.
    audio.addEventListener("play", async () => {
      if (audioCtx.state === "suspended") {
        await audioCtx.resume();
      }
    });
  </script>
</body>
</html>